<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script>
		var url = window.location.href;
		var state = url.substring(url.indexOf('=')+1, url.indexOf('&'))
		var code = url.substring(url.indexOf('code=')+5, url.length)
		// var params = url.substring(url.indexOf('?')+1, url.length);

		function saveAccessToken(response) {
			sessionStorage.access_token = response.access_token
		}

		function boxOAuth() {
			if (sessionStorage.access_token) {
				authenticationSuccess();
			} else {
				var xhr = new XMLHttpRequest();
				xhr.open('POST', 'https://api.box.com/oauth2/token', true);
				xhr.responseType = 'json';
				xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
				xhr.onload = function () {
					if (xhr.status = 200) {
						authenticationSuccess();
				        saveAccessToken(xhr.response);
					}
				};
				xhr.send('grant_type=authorization_code&code=' + code + '&client_id=4v47e213getqp2da9aggsd589r2ui1iz&client_secret=secret');
			}
		}

		function authenticationSuccess() {
			var div = document.getElementById("success_msg");
			div.style.visibility = "visible"
		}

		function fetchAndIndexImagesFromBox() {
			fetchImagesFromBox();
			indexImages();
		}

		function fetchImagesFromBox() {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', 'https://api.box.com/2.0/search?query=jpeg', true);
			xhr.setRequestHeader('Authorization', 'Bearer ' + sessionStorage.access_token)
			xhr.responseType = 'json';
			xhr.onload = function () {
				if (xhr.status = 200) {
					saveBoxSearchJsonResponse(xhr.response)
				}
			};
			xhr.send();
		}

		function saveBoxSearchJsonResponse(response) {
			var imageIds = JSON.parse('{}');
			if(sessionStorage.imageIds) {
				imageIds = JSON.parse(sessionStorage.imageIds);
			}

			for (index = 0; index < response.total_count; index++) {
				img_id = response.entries[index].id;
				if (!imageIds.hasOwnProperty(img_id)) {
					imageIds[img_id] = false;
				}
			}
			sessionStorage.imageIds = JSON.stringify(imageIds);
			document.getElementById("img_search_results").textContent = "Found " + response.total_count + " image(s)!";
		}

		function indexImages() {
			if (sessionStorage.imageIds) {
				imageIds = JSON.parse(sessionStorage.imageIds);
				for (var imageId in imageIds) {
					if (imageIds.hasOwnProperty(imageId) && !imageIds[imageId]) {
						fetchImageFromBox(imageId);
					}
				}
			}
		}

		function fetchImageFromBox(imageId) {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', 'https://api.box.com/2.0/files/' + imageId + '/content', true);
			xhr.setRequestHeader('Authorization', 'Bearer ' + sessionStorage.access_token)
			xhr.responseType = 'blob';
			xhr.onload = function () {
				if (xhr.status = 200) {
					renderImage(xhr.response);
				}
			};
			xhr.send();
		}

		function renderImage(imageBlob) {
			var imageUrl = URL.createObjectURL(imageBlob);
			document.getElementById("image_indexing_progress_msg").textContent = "Processing following image:";
			document.querySelector("#selected_image").src = imageUrl;
		}

	</script>
</head>


<body onload="boxOAuth()";>
	<h2 style="color:maroon">imgFind</h2>
	<div id="success_msg" visibility="hidden">
		Congratulations! You have successfully connected your Box account! <br><br>
		To make your image files in Box searchable click below! <br>
		<button onclick="fetchAndIndexImagesFromBox()">Index Images!</button> <br><br>
	</div>
	<div id="img_search_results">
	</div>
	<br>
	<br>
	<div id="image_indexing_progress_msg">
	</div>
	<div id="image_indexing_progress">
		<img id="selected_image"/>
	</div>
	
</body>

</html>
