
<!DOCTYPE html>
<html>

<head>
    <title>ImgFind</title>
    <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script>
    <script>
    var url = window.location.href;
    var state = url.substring(url.indexOf('=') + 1, url.indexOf('&'))
    var code = url.substring(url.indexOf('code=') + 5, url.length)

    function boxOAuth(refresh = false) {
        var access_tokens = getLocalAccessTokens();
        if (access_tokens.hasOwnProperty('box') &&
            access_tokens.box.hasOwnProperty('access_token') &&
            access_tokens.box.access_token != null) {
            authenticationSuccess();
        } else {
            var requestBody = new URLSearchParams();
            if (refresh && access_tokens.hasOwnProperty('box') &&
                access_tokens.box.hasOwnProperty('refresh_token') &&
                access_tokens.box.refresh_token != null) {
                requestBody.append('grant_type', 'refresh_token');
                requestBody.append('refresh_token', access_tokens.box.refresh_token);
            } else {
                requestBody.append('grant_type', 'authorization_code');
                requestBody.append('code', code);
            }
            requestBody.append('client_id', '1cf9xjqa83lx77agvkmm7rg635wvuh7t');
            requestBody.append('client_secret', 'o0p0xgaRvSooele09STKonmKLJiFzNbv');
            var headers = new Headers({ 'Content-Type': 'application/x-www-form-urlencoded' });
            var httpResponse = httpRequest('https://api.box.com/oauth2/token', headers, requestBody, 'POST');

            httpResponse.then(function(response) {
                if (response.status == 200) {
                    return response.json();
                }
                throw new Error("Box OAuth failed with response code:" + response.statusText);

            }).then(function(responseJson) {
                access_tokens.box = {
                    access_token: responseJson.access_token,
                    refresh_token: responseJson.refresh_token
                };

                setLocalAccessTokens(access_tokens);
                authenticationSuccess();

            }).catch(function(error) {
                console.log(error);
                authenticationFailure();
            });
        }
    }

    function authenticationSuccess() {
        var button = document.createElement("button");
        button.innerHTML = "Index Images!";
        button.addEventListener("click", function() {
            fetchAndIndexImagesFromBox();
        });

        var div = document.getElementById("success_msg");
        div.innerHTML = "Congratulations! You have successfully connected your Box account! <br><br> To make your image files in Box searchable click below! <br>";
        div.appendChild(button);

        div.style.visibility = "visible"
    }

    function authenticationFailure() {
        var div = document.getElementById("success_msg");
        div.innerHTML = "Sorry! Authorization failed! <br>";
        div.style.visibility = "visible"
    }

    function getLocalAccessTokens() {
        if (sessionStorage.access_tokens === undefined || sessionStorage.access_tokens == null) {
            return {};
        } else {
            return JSON.parse(sessionStorage.access_tokens);
        }
    }

    function setLocalAccessTokens(access_tokens) {
        if (access_tokens == null) {
            sessionStorage.access_tokens = '{}';
        } else {
            sessionStorage.access_tokens = JSON.stringify(access_tokens);
        }
    }

    function fetchAndIndexImagesFromBox() {
        fetchAndStoreImageIdsFromBox();
        indexImages();
    }

    function refreshBoxToken() {
        boxOAuth(true);
    }

    function fetchAndStoreImageIdsFromBox() {
        // TODO: search other image formats
        var httpResponse = fetchDataFromBox('https://api.box.com/2.0/search?query=png');
        // TODO: Implement paginated fetch
        httpResponse.then(function(response) {
            if (response.status == 200) {
                return response.responseBody;
                // return response.json(); // To be used with fetch
            }
            throw new Error("Fetching image ids from Box failed with response code:" + response.statusText);
        }).then(saveBoxSearchJsonResponse).catch(function(error) {
            console.log(error);
        });
    }

    function saveBoxSearchJsonResponse(response) {
        var imageIds = JSON.parse('{}');
        if (sessionStorage.imageIds) {
            imageIds = JSON.parse(sessionStorage.imageIds);
        }

        for (index = 0; index < response.entries.length; index++) {
            img_id = response.entries[index].id;
            if (!imageIds.hasOwnProperty(img_id)) {

                imageIds[img_id] = false
            }
        }

        sessionStorage.imageIds = JSON.stringify(imageIds);
        document.getElementById("img_search_results").textContent = "Found " + response.total_count + " image(s)!";
    }

    function indexImages() {
        if (sessionStorage.imageIds) {
            imageIds = JSON.parse(sessionStorage.imageIds);

            for (var imageId in imageIds) {
                if (imageIds.hasOwnProperty(imageId) && !imageIds[imageId].processed) {

                	metadata(imageId)

                    // To be used with fetch
                    // fetchImageFromBox(imageId).then(function(response) {
                    //     if (response.status == 200) {
                    //         return response.blob(); // used with fetch
                    //     }
                    //     throw new Error("Fetching image from Box failed with response code:" + response.statusText);
                    // }).then(parseImage).then(renderImage).catch(function(error) {
                    //     console.log("Indexing image with id: " + imageId + " failed");
                    //     console.log(error);
                    // });
                }
            }
        }
    }

    function metadata(fileId) {

        var access_tokens = getLocalAccessTokens();

        // var fileId = data[0].imageId;
       
        var headers = new Headers({ 'Content-Type': 'application/json', 'Authorization' : 'Bearer ' + access_tokens.box.access_token });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata', headers, null, 'GET');

        httpResponse.then(function(response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function(res) {
        	checkAndUpdate(res, fileId);
        }).catch(function(error) {
            console.log(error);
        });
    }


    function checkAndUpdate(res, imageId) {

    	if(res && res.entries && res.entries.length != 0 && res.entries[0].imageContent) {
    		console.log("Metadata already exists");
    	} else {
    		
    		var imgFetch = fetchImageFromBox(imageId).then(function(response) {
                
                if (response.status == 200) {

                    var result =  {
                        "imageBlob" : response.responseBody,
                        "imageId" : imageId
                    }
                    
                    return result;
                }
                throw new Error("Fetching image from Box failed with response code:" + response.statusText);
            });
            
            var imgParse = imgFetch.then(parseImage);

            if(res.entries.length == 0){
	            Promise.all([imgFetch, imgParse]).then(addNewMetadata).catch(function(error) {
	                console.log("Indexing image with id: " + imageId + " failed");
	                console.log(error);
	            });
	        } else {
	        	 Promise.all([imgFetch, imgParse]).then(updateMetadata).catch(function(error) {
	                console.log("Indexing image with id: " + imageId + " failed");
	                console.log(error);
	            });
	        }

    	}
    }

    function updateMetadata(data) {
        var access_tokens = getLocalAccessTokens();
        
        var metadata = [{
            "op" : "add",
            "path" : "/imageContent",
            "value" : data[1]
        }]

        var fileId = data[0].imageId;

        var xhr = new XMLHttpRequest();
        
        var headers = new Headers({ 'Content-Type': 'application/json-patch+json', 'Authorization' : 'Bearer ' + access_tokens.box.access_token });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata/global/properties', headers, JSON.stringify(metadata), 'PUT');

        httpResponse.then(function(response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function(res) {
        	console.log("Metadata Updated");
        }).catch(function(error) {
            console.log("Some error occured while updating metadata");
        });
       
    }

    function addNewMetadata(data) {
        
        var access_tokens = getLocalAccessTokens();

        var body = {
        	"imageContent" : data[1]
        }

        var fileId = data[0].imageId;

        var headers = new Headers({ 'Content-Type': 'application/json', 'Authorization' : 'Bearer ' + access_tokens.box.access_token });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata/global/properties', headers, JSON.stringify(body), 'POST');

        httpResponse.then(function(response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function(res) {
        	console.log("Metadata Added");
        }).catch(function(error) {
            console.log("Some error occured while adding metadata");
        });

    }



    function fetchImageFromBox(imageId) {
        return fetchDataFromBox('https://api.box.com/2.0/files/' + imageId + '/content', 'blob');
        // With fetch
        // return fetchDataFromBox('https://api.box.com/2.0/files/' + imageId + '/content');
    }

    function fetchDataFromBox(url, responseType = 'json') {
        return new Promise(function(resolve, reject) {

            access_tokens = getLocalAccessTokens();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + access_tokens.box.access_token);
            xhr.responseType = responseType;
            xhr.onload = function() {
                if (xhr.status = 200) {
                    resolve({
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseBody: xhr.response
                    });
                } else {
                    reject({
                        status: xhr.status,
                        statusText: xhr.statusText
                    });
                }
            };
            xhr.onerror = function() {
                reject({
                    status: xhr.status,
                    statusText: xhr.statusText
                });
            };
            xhr.send();
        });


        // To be used once fetch stops lowercasing headers
        // var headers = new Headers({Authorization: 'Bearer ' + access_tokens.box.access_token });
        // return httpRequest(url, headers);
    }

    function parseImage(imageBlob) {
        return new Promise(function(resolve, reject) {
            Tesseract.recognize(imageBlob.imageBlob)
                .then(function(result) {
                    resolve(result.text);
                }).catch(function(error) {
                    reject("Parsing image failed with: " + error.message);
                });
        });
    }

    function httpRequest(url, headers, body, method = 'GET', mode = 'cors') {
        if (url == null) {
            throw "URL is not specified for the request."
        }
        request = {
            'method': method,
            'mode': mode
        }
        if (body != null) {
            request.body = body;
        }
        if (headers != null) {
            request.headers = headers;
        }

        return fetch(url, request);
    }
    </script>
</head>

<body onload="boxOAuth()" ;>
    <h2 style="color:maroon">imgFind</h2>
    <div id="success_msg">
    </div>
    <div id="img_search_results">
    </div>
    <br>
    <br>
    <div id="image_indexing_progress">
    </div>
</body>

</html>