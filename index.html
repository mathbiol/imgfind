<!DOCTYPE html>
<html>

<head>
    <title></title>
    <script>
    var url = window.location.href;
    var state = url.substring(url.indexOf('=') + 1, url.indexOf('&'))
    var code = url.substring(url.indexOf('code=') + 5, url.length)

    function boxOAuth() {
        var access_tokens = getLocalAccessTokens();
        if (access_tokens.hasOwnProperty('box') &&
            access_tokens.box.hasOwnProperty('access_token') &&
            access_tokens.box.access_token != null) {
            authenticationSuccess();
        } else {
            var requestBody = new URLSearchParams();
            requestBody.append('grant_type', 'authorization_code');
            requestBody.append('code', code);
            requestBody.append('client_id', '4v47e213getqp2da9aggsd589r2ui1iz');
            requestBody.append('client_secret', 'opWSY6oXqQd3KaNRcaVm9waczXfe6n2V');
            var headers = new Headers({ 'Content-Type': 'application/x-www-form-urlencoded' });
            var httpResponse = httpRequest('https://api.box.com/oauth2/token', requestBody, headers, 'POST');

            httpResponse.then(function(response) {
                if (response.status == 200) {
                    return response.json();
                }
                throw new Error("Box OAuth failed with response code:" + response.statusText);
            }).then(function(responseJson) {
                access_tokens.box = {
                    access_token: responseJson.access_token,
                    refresh_token: responseJson.refresh_token
                };
                setLocalAccessTokens(access_tokens);
                authenticationSuccess();
            }).catch(function(error) {
                console.log(error);
                authenticationFailure();
            });
        }
    }

    function authenticationSuccess() {
        var button = document.createElement("button");
        button.innerHTML = "Index Images!";
        button.addEventListener("click", function() {
            fetchAndIndexImagesFromBox();
        });

        var div = document.getElementById("success_msg");
        div.innerHTML = "Congratulations! You have successfully connected your Box account! <br><br> To make your image files in Box searchable click below! <br>";
        div.appendChild(button);

        div.style.visibility = "visible"
    }

    function authenticationFailure() {
        var div = document.getElementById("success_msg");
        div.innerHTML = "Sorry! Authorization failed! <br>";
        div.style.visibility = "visible"
    }

    function getLocalAccessTokens() {
        if (sessionStorage.access_tokens === undefined || sessionStorage.access_tokens == null) {
            return {};
        } else {
            return JSON.parse(sessionStorage.access_tokens);
        }
    }

    function setLocalAccessTokens(access_tokens) {
        if (access_tokens == null) {
            sessionStorage.access_tokens = '{}';
        } else {
            sessionStorage.access_tokens = JSON.stringify(access_tokens);
        }
    }

    function httpRequest(url, body, headers, method = 'GET', mode = 'cors') {
        if (url == null) {
            throw "URL is not specified for the request."
        }
        request = {
            'method': method,
            'mode': mode
        }
        if (body != null) {
            request.body = body;
        }
        if (headers != null) {
            request.headers = headers;
        }

        return fetch(url, request);
    }
    </script>
</head>

<body onload="boxOAuth()" ;>
    <h2 style="color:maroon">imgFind</h2>
    <div id="success_msg">
    </div>
    <div id="img_search_results">
    </div>
    <br>
    <br>
    <div id="image_indexing_progress_msg">
    </div>
    <div id="image_indexing_progress">
        <img id="selected_image" />
    </div>
</body>

</html>