<!DOCTYPE html>
<html>

<head>
    <title>ImgFind</title>
    <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script>
    <script>
    var url = window.location.href;
    var state = url.substring(url.indexOf('=') + 1, url.indexOf('&'))
    var code = url.substring(url.indexOf('code=') + 5, url.length)
    var img_extensions = ['png', 'jpg', 'jpeg', 'svg', 'tif', 'bmp', 'pnm'];

    function boxOAuth(refresh = false) {
        var access_tokens = getLocalAccessTokens();
        sessionStorage.service = 'box';
        if (access_tokens.hasOwnProperty('box') &&
            access_tokens.box.hasOwnProperty('access_token') &&
            access_tokens.box.access_token != null) {
            authenticationSuccess();
        } else {
            var requestBody = new URLSearchParams();
            if (refresh && access_tokens.hasOwnProperty('box') &&
                access_tokens.box.hasOwnProperty('refresh_token') &&
                access_tokens.box.refresh_token != null) {
                requestBody.append('grant_type', 'refresh_token');
                requestBody.append('refresh_token', access_tokens.box.refresh_token);
            } else {
                requestBody.append('grant_type', 'authorization_code');
                requestBody.append('code', code);
            }
            requestBody.append('client_id', '1cf9xjqa83lx77agvkmm7rg635wvuh7t');
            requestBody.append('client_secret', 'o0p0xgaRvSooele09STKonmKLJiFzNbv');
            var headers = new Headers({'Content-Type': 'application/x-www-form-urlencoded'});
            var httpResponse = httpRequest('https://api.box.com/oauth2/token', headers, requestBody, 'POST');
            httpResponse.then(function (response) {
                if (response.status == 200) {
                    return response.json();
                }
                throw new Error("Box OAuth failed with response code:" + response.statusText);

            }).then(function (responseJson) {
                access_tokens.box = {
                    access_token: responseJson.access_token,
                    refresh_token: responseJson.refresh_token
                };

                setLocalAccessTokens(access_tokens);
                authenticationSuccess();

            }).catch(function (error) {
                console.log(error);
                authenticationFailure();
            });
        }
    }

    function authenticationSuccess() {
        var button = document.createElement("button");
        button.innerHTML = "Index Images!";
        button.addEventListener("click", function () {
            fetchAndIndexImagesFromBox();
        });
        document.getElementById("connect").style.display="none";
        document.getElementById("afterConnect").style.display="block";
        var div = document.getElementById("success_msg");
        div.innerHTML = "Congratulations! You have successfully connected your Box account! <br><br>" +
            " To make your image files in Box searchable click below! <br>";
        div.appendChild(button);

        div.style.visibility = "visible"
    }

    function authenticationFailure() {
        document.getElementById("connect").style.display="block";
        document.getElementById("afterConnect").style.display="none";
        // var div = document.getElementById("success_msg");
        // div.innerHTML = "Sorry! Authorization failed! <br>";
        // div.style.visibility = "visible"
    }

    function getLocalAccessTokens() {
        if (sessionStorage.access_tokens === undefined || sessionStorage.access_tokens == null) {
            return {};
        } else {
            return JSON.parse(sessionStorage.access_tokens);
        }
    }

    function setLocalAccessTokens(access_tokens) {
        if (access_tokens == null) {
            sessionStorage.access_tokens = '{}';
        } else {
            sessionStorage.access_tokens = JSON.stringify(access_tokens);
        }
    }

    function fetchAndIndexImagesFromBox() {
        fetchImageIdsFromBox();
        indexImages();
    }

    function refreshBoxToken() {
        boxOAuth(true);
    }

    function fetchImageIdsFromBox() {
        var limit = 100;
        var offset = 0;
        for (var index = 0; index < img_extensions.length; index++) {
            fetchAndStoreImageIdsFromBox(img_extensions[index], offset, limit);
        }
    }

    function fetchAndStoreImageIdsFromBox(extension, offset=0, limit=100) {
        var url = 'https://api.box.com/2.0/search?query=' + extension + '&fields=id&limit=' + limit +
            '&offset=' + offset + '&type=file&file_extensions=' + img_extensions.join(",");
        var httpResponse = fetchDataFromBox(url);
        var totalEntries = 0;
        var apiResponse = httpResponse.then(function (response) {
            if (response.status == 200) {
                totalEntries = response.responseBody.total_count;
                return response.responseBody;
                // return response.json(); // To be used with fetch
            }
            throw new Error("Fetching image ids from Box failed with response code:" + response.statusText);
        });

        apiResponse.then(saveBoxImageSearchResponse).catch(function (error) {
            console.log(error);
        });

        apiResponse.then(function (response) {
            var nextOffset = offset + limit;
            if (totalEntries > nextOffset) {
                fetchAndStoreImageIdsFromBox(extension, nextOffset, limit);
            }
        }).catch(function (error) {
            console.log(error);
        });
    }

    function saveBoxImageSearchResponse(response) {
        var imageIds = JSON.parse('{}');
        if (sessionStorage.imageIds) {
            imageIds = JSON.parse(sessionStorage.imageIds);
        }

        for (index = 0; index < response.entries.length; index++) {
            img_id = response.entries[index].id;
            if (!imageIds.hasOwnProperty(img_id)) {

                imageIds[img_id] = false
            }
        }

        sessionStorage.imageIds = JSON.stringify(imageIds);
        // document.getElementById("img_search_results").textContent = "Found " + response.total_count + " image(s)!";
    }

    function indexImages() {
        if (sessionStorage.imageIds) {
            imageIds = JSON.parse(sessionStorage.imageIds);

            for (var imageId in imageIds) {
                if (imageIds.hasOwnProperty(imageId) && !imageIds[imageId].processed) {

                    metadata(imageId)

                    // To be used with fetch
                    // fetchImageFromBox(imageId).then(function(response) {
                    //     if (response.status == 200) {
                    //         return response.blob(); // used with fetch
                    //     }
                    //     throw new Error("Fetching image from Box failed with response code:" + response.statusText);
                    // }).then(parseImage).then(renderImage).catch(function(error) {
                    //     console.log("Indexing image with id: " + imageId + " failed");
                    //     console.log(error);
                    // });
                }
            }
        }
    }

    function metadata(fileId) {

        var access_tokens = getLocalAccessTokens();

        // var fileId = data[0].imageId;

        var headers = new Headers({
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + access_tokens.box.access_token
        });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata', headers, null, 'GET');

        httpResponse.then(function (response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function (res) {
            checkAndUpdate(res, fileId);
        }).catch(function (error) {
            console.log(error);
        });
    }


    function checkAndUpdate(res, imageId) {

        if (res && res.entries && res.entries.length != 0 && res.entries[0].imageContent) {
            console.log("Metadata already exists");
        } else {

            var imgFetch = fetchImageFromBox(imageId).then(function (response) {

                if (response.status == 200) {

                    var result = {
                        "imageBlob": response.responseBody,
                        "imageId": imageId
                    }
                    return result;
                }
                throw new Error("Fetching image from Box failed with response code:" + response.statusText);
            });

            var imgParse = imgFetch.then(parseImage);

            if (res.entries.length == 0) {
                Promise.all([imgFetch, imgParse]).then(addNewMetadata).catch(function (error) {
                    console.log("Indexing image with id: " + imageId + " failed");
                    console.log(error);
                });
            } else {
                Promise.all([imgFetch, imgParse]).then(updateMetadata).catch(function (error) {
                    console.log("Indexing image with id: " + imageId + " failed");
                    console.log(error);
                });
            }

        }
    }

    function updateMetadata(data) {
        var access_tokens = getLocalAccessTokens();

        var metadata = [{
            "op": "add",
            "path": "/imageContent",
            "value": data[1]
        }]

        var fileId = data[0].imageId;

        var xhr = new XMLHttpRequest();

        var headers = new Headers({
            'Content-Type': 'application/json-patch+json',
            'Authorization': 'Bearer ' + access_tokens.box.access_token
        });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata/global/properties',
            headers, JSON.stringify(metadata), 'PUT');

        httpResponse.then(function (response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function (res) {
            console.log("Metadata Updated");
        }).catch(function (error) {
            console.log("Some error occured while updating metadata");
        });

    }

    function addNewMetadata(data) {

        var access_tokens = getLocalAccessTokens();

        var body = {
            "imageContent": data[1]
        }

        var fileId = data[0].imageId;

        var headers = new Headers({
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + access_tokens.box.access_token
        });
        var httpResponse = httpRequest('https://api.box.com/2.0/files/' + fileId + '/metadata/global/properties', headers, JSON.stringify(body), 'POST');

        httpResponse.then(function (response) {
            if (response.status == 200) {
                return response.json();
            }
        }).then(function (res) {
            console.log("Metadata Added");
        }).catch(function (error) {
            console.log("Some error occured while adding metadata");
        });

    }


    function fetchImageFromBox(imageId) {
        return fetchDataFromBox('https://api.box.com/2.0/files/' + imageId + '/content', 'blob');
        // With fetch
        // return fetchDataFromBox('https://api.box.com/2.0/files/' + imageId + '/content');
    }

    function fetchDataFromBox(url, responseType = 'json') {
        return new Promise(function (resolve, reject) {

            access_tokens = getLocalAccessTokens();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + access_tokens.box.access_token);
            xhr.responseType = responseType;
            xhr.onload = function () {
                if (xhr.status = 200) {
                    resolve({
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseBody: xhr.response
                    });
                } else {
                    reject({
                        status: xhr.status,
                        statusText: xhr.statusText
                    });
                }
            };
            xhr.onerror = function () {
                reject({
                    status: xhr.status,
                    statusText: xhr.statusText
                });
            };
            xhr.send();
        });


        // To be used once fetch stops lowercasing headers
        // var headers = new Headers({Authorization: 'Bearer ' + access_tokens.box.access_token });
        // return httpRequest(url, headers);
    }

    function parseImage(imageBlob) {
        return new Promise(function (resolve, reject) {
            Tesseract.recognize(imageBlob.imageBlob)
                .then(function (result) {
                    resolve(result.text);
                }).catch(function (error) {
                reject("Parsing image failed with: " + error.message);
            });
        });
    }

    function httpRequest(url, headers, body, method = 'GET', mode = 'cors') {
        if (url == null) {
            throw "URL is not specified for the request."
        }
        request = {
            'method': method,
            'mode': mode
        }
        if (body != null) {
            request.body = body;
        }
        if (headers != null) {
            request.headers = headers;
        }
        return fetch(url, request);
    }

    function searchFilesInBox(url='', offset=0, limit=100) {
        if (url == '') {
            var searchVal = document.getElementById("file_search_box").value;
            if (searchVal != null && searchVal.trim() != '') {
                url = 'https://api.box.com/2.0/search?query=' + searchVal.trim() + '&fields=id,name&type=file'
            }
        }
        if (url == '') {
            return;
        }
        var httpResponse = fetchDataFromBox(url + '&offset=' + offset + '&limit=' + limit);
        var totalEntries = 0;
        var apiResponse = httpResponse.then(function (response) {
            if (response.status == 200) {
                totalEntries = response.responseBody.total_count;
                return response.responseBody;
                // return response.json(); // To be used with fetch
            }
            throw new Error("Fetching image ids from Box failed with response code:" + response.statusText);
        }).catch(function (error) {
            console.log(error);
        });

        apiResponse.then(handleFileSearchResponse).catch(function (error) {
            console.log(error);
        });

        apiResponse.then(function (response) {
            var nextOffset = offset + limit;
            if (totalEntries > nextOffset) {
                searchFilesInBox(url, nextOffset, limit)
            }
        }).catch(function (error) {
            console.log(error);
        });
    }

    function handleFileSearchResponse(response) {
        var div = document.getElementById("search_results");
        div.innerHTML = '';
        var results_found = response.total_count;
        div.append(document.createElement("br"));
        div.append('\nFound ' + results_found + ' result(s) for your search query!')
        div.append(document.createElement("br"));
        for (var index = 0; index < response.entries.length; index++) {
            var link = document.createElement("a");
            var linkText = document.createTextNode(response.entries[index].name);
            link.appendChild(linkText);
            // link.title = response.entries[index].name;
            link.target = "_blank";
            link.href = "https://app.box.com/file/" + response.entries[index].id;
            div.appendChild(link);
            div.append(document.createElement("br"));
        }
    }

    </script>
</head>

<body onload="boxOAuth()" ;>
<h2 style="color:maroon">imgFind</h2>

<div id = "connect" style= "display:none">
    <button onclick="location.href = 'https://account.box.com/api/oauth2/authorize?response_type=code&client_id=1cf9xjqa83lx77agvkmm7rg635wvuh7t&state=security_token%3DKnhMJatFipTAnM0nHlZA'"; type="button">
        Connect to Box!
    </button> 
</div>

<div id = "afterConnect" style = "display:none">
    <div id="success_msg">
    </div>
    <div id="img_search_results">
    </div>
    <br>
    <br>
    <div id="image_indexing_progress">
    </div>
    <div id="search_space">
        <h3>File Search</h3>
        <input type="search" id="file_search_box" placeholder="Search your files">
        <button onclick="searchFilesInBox()">Go!</button>
    </div>
    <div id="search_results">
    </div>
</div>
</body>

</html>
